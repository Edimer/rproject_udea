---
title: "Análisis estadístico de experimentos"
author: "Edimer David Jaramillo"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Experimento con 1 factor

## Datos

```{r}
library(tidyverse)
library(readxl)
library(janitor)
datos_cafe <- read_excel("datos_café.xlsx") %>% 
  clean_names() %>% 
  mutate(mycorrhizal_colonization = as.numeric(mycorrhizal_colonization))
datos_cafe
```

## Resumen descriptivo básico

```{r}
datos_cafe %>% 
  group_by(system) %>% 
  summarise(promedio = mean(mycorrhizal_colonization),
            desviacion = sd(mycorrhizal_colonization),
            N = n())
```

## Boxplot

```{r}
datos_cafe %>% 
  ggplot(mapping = aes(x = system, y = mycorrhizal_colonization)) +
  geom_boxplot()
```

## Modelo estadístico

$$y_{ij} = \mu + \beta_j +  \epsilon_{ij}$$

Donde:

- $y_{ij}$: variable respuesta. En este caso es la colonización micorrizal.
- $\mu$: media general para la variable respuesta.
- $\beta_j$: efecto del $j-ésimo$ sistema sobre la variable colonización micorrizal. Donde $j = 1, 2, 3$
- $\epsilon_{ij}$: error experimental

## Hipótesis

$$H_0: \mu_{Conventional} = \mu_{Agroecological} = \mu_{Forest} \\
H_1: \mu_i \neq \mu_j$$

## Nivel de significancia

- En este caso vamos a usar el 5%.

## Anova

- En R podemos usar la función "aov()" para ejecutar análisis de varianza.
- También podemos utilizar la función "lm()" para ejecutar análisis de varianza.

```{r}
modelo_cafe <- aov(formula = mycorrhizal_colonization ~ system,
                   data = datos_cafe)

# Resumen del modelo
summary(modelo_cafe)
```

- **Conclusión:** como el valor p (0.0062) es menor que el nivel de significancia (0.05), existe evidencia para rechazar la hipótesis nula, es decir, que al menos un par de sistemas difieren estadísticamente para la colonización micorrizal.

## Análisis de residuales

- Podemos obtener los residuales del modelo con la función "residuals()":

```{r}
residuales_cafe <- residuals(modelo_cafe)
residuales_cafe
```

### Normalidad

```{r}
library(ggpubr)
ggqqplot(residuales_cafe)
```

- Prueba de shapiro wilk: la normalidad no se cumple, sin embargo, los desvíos que se observan en el gŕafico parecen ser pequeños.

```{r}
shapiro.test(residuales_cafe)
```

### Homocedasticidad

- La homocedasticidad sí se cumple.

```{r}
library(car)
leveneTest(residuales_cafe ~ datos_cafe$system)
```

- Gráfico de ajustados vs residuales:

```{r}
ajustados_cafe <- fitted(modelo_cafe)

plot(x = ajustados_cafe, y = residuales_cafe)
```

- Gráficos de residuales por defecto con la función "plot()":

```{r}
par(mfrow = c(2, 2))
plot(modelo_cafe)
```

## Estimaciones

### Promedios

- Con la función "model.tables()" podemos obtener los promedios estimados:

```{r}
model.tables(x = modelo_cafe,
             type = "means",
             se = TRUE)
```

### Efectos

- Los efectos (positivos o negativos) pueden ser obtenidos con la misma función "model.tables()"

```{r}
model.tables(x = modelo_cafe,
             type = "effects",
             se = TRUE)
```

### Promedios e IC

- En este caso vamos a usar la biblioteca ggeffects:

```{r}
library(ggeffects)
ggeffect(model = modelo_cafe)
```

## Comparaciones múltiples

- Podemos utilizar métodos con y sin ajuste del valor p.

### Sin ajuste

```{r}
pairwise.t.test(x = datos_cafe$mycorrhizal_colonization,
                g = datos_cafe$system,
                p.adjust.method = "none", 
                alternative = "two.sided")
```


### Con ajuste

- Bonferroni:

```{r}
pairwise.t.test(x = datos_cafe$mycorrhizal_colonization,
                g = datos_cafe$system,
                p.adjust.method = "bonferroni", 
                alternative = "two.sided")
```

- Holm:

```{r}
pairwise.t.test(x = datos_cafe$mycorrhizal_colonization,
                g = datos_cafe$system,
                p.adjust.method = "holm", 
                alternative = "two.sided")
```

### Tukey

```{r}
TukeyHSD(x = modelo_cafe)
```

## Reporte de resultados

### Gráficos

- Medias estimadas e intervalos de confianza:

```{r}
g1 <- ggeffect(model = modelo_cafe)
plot(g1)
```

- Gráfico de comparación de medias con Tukey:

```{r}
library(broom)
g2 <- TukeyHSD(x = modelo_cafe) %>% tidy()
g2 %>% 
  ggplot(mapping = aes(x = contrast, y = estimate)) +
  geom_point() +
  geom_errorbar(mapping = aes(ymin = conf.low, ymax = conf.high),
                width = 0.2) +
  geom_hline(yintercept = 0, lty = 2, color = "red") +
  coord_flip()
```

### Tamaño del efecto

- En este caso el tamaño del efecto es moderado o medio.

```{r}
library(effectsize)
eta_squared(model = modelo_cafe)
```

